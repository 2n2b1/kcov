<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>Coverage - ./kcov</title>
  <link rel="stylesheet" type="text/css" href="bcov.css"/>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr><td class="title">Coverage Report</td></tr>
  <tr><td class="ruler"><img src="glass.png" width="3" height="3" alt=""/></td></tr>
  <tr>
    <td width="100%">
      <table cellpadding="1" border="0" width="100%">
        <tr>
          <td class="headerItem" width="20%">Command:</td>
          <td class="headerValue" width="80%" colspan=6>./kcov</td>
        </tr>
        <tr>
          <td class="headerItem" width="20%">Date:</td>
          <td class="headerValue" width="15%">2010-11-27 09:08:49</td>
          <td width="5%"></td>
          <td class="headerItem" width="20%">Instrumented&nbsp;lines:</td>
          <td class="headerValue" width="10%">51</td>
        </tr>
        <tr>
          <td class="headerItem" width="20%">Code&nbsp;covered:</td>
          <td class="coverPerLeftLo" width="15%">0.0 %</td>
          <td width="5%"></td>
          <td class="headerItem" width="20%">Executed&nbsp;lines:</td>
          <td class="headerValue" width="10%">0</td>
        </tr>
      </table>
    </td>
  </tr>
  <tr><td class="ruler"><img src="glass.png" width="3" height="3" alt=""/></td></tr>
</table>
<pre class="source">
<span class="lineNum">      1 </span>              : /* </span>
<span class="lineNum">      2 </span>              :  * Copyright (C) 2010 Simon Kagstrom </span>
<span class="lineNum">      3 </span>              :  * </span>
<span class="lineNum">      4 </span>              :  * See COPYING for license details </span>
<span class="lineNum">      5 </span>              :  */ </span>
<span class="lineNum">      6 </span>              : #define _GNU_SOURCE </span>
<span class="lineNum">      7 </span>              :  </span>
<span class="lineNum">      8 </span>              : #include &lt;kc.h&gt; </span>
<span class="lineNum">      9 </span>              : #include &lt;stdio.h&gt; </span>
<span class="lineNum">     10 </span>              : #include &lt;utils.h&gt; </span>
<span class="lineNum">     11 </span>              : #include &lt;fcntl.h&gt; </span>
<span class="lineNum">     12 </span>              : #include &lt;errno.h&gt; </span>
<span class="lineNum">     13 </span>              : #include &lt;unistd.h&gt; </span>
<span class="lineNum">     14 </span>              :  </span>
<span class="lineNum">     15 </span>              : static char debugfs_path[PATH_MAX]; </span>
<span class="lineNum">     16 </span>              : static const char *kprobe_coverage_write_path; </span>
<span class="lineNum">     17 </span>              : static const char *kprobe_coverage_read_path; </span>
<span class="lineNum">     18 </span>              :  </span>
<span class="lineNum">     19 </span>              : /* From lttng */ </span>
<span class="lineNum">     20 </span>              : static int lookup_debugfs(void) </span>
<span class="lineNum">     21 </span><span class="lineNoCov">    0 / 2     : { </span>
<span class="lineNum">     22 </span>              : 	char mnt_dir[PATH_MAX]; </span>
<span class="lineNum">     23 </span>              : 	char mnt_type[PATH_MAX]; </span>
<span class="lineNum">     24 </span><span class="lineNoCov">    0 / 1     : 	int ret = -ENOENT; </span>
<span class="lineNum">     25 </span>              :  </span>
<span class="lineNum">     26 </span><span class="lineNoCov">    0 / 1     : 	FILE *fp = fopen(&quot;/proc/mounts&quot;, &quot;r&quot;); </span>
<span class="lineNum">     27 </span><span class="lineNoCov">    0 / 1     : 	if (!fp) </span>
<span class="lineNum">     28 </span><span class="lineNoCov">    0 / 1     : 		return -EINVAL; </span>
<span class="lineNum">     29 </span>              :  </span>
<span class="lineNum">     30 </span>              : 	while (1) { </span>
<span class="lineNum">     31 </span><span class="lineNoCov">    0 / 1     : 		if (fscanf(fp, &quot;%*s %s %s %*s %*s %*s&quot;, mnt_dir, mnt_type) &lt;= 0) </span>
<span class="lineNum">     32 </span><span class="lineNoCov">    0 / 1     : 			panic(&quot;Debugfs does not seem to be mounted anywhere\n&quot;); </span>
<span class="lineNum">     33 </span>              :  </span>
<span class="lineNum">     34 </span><span class="lineNoCov">    0 / 1     : 		if (!strcmp(mnt_type, &quot;debugfs&quot;)) { </span>
<span class="lineNum">     35 </span><span class="lineNoCov">    0 / 1     : 			strcpy(debugfs_path, mnt_dir); </span>
<span class="lineNum">     36 </span>              : 			break; </span>
<span class="lineNum">     37 </span>              : 		} </span>
<span class="lineNum">     38 </span><span class="lineNoCov">    0 / 1     : 	} </span>
<span class="lineNum">     39 </span>              :  </span>
<span class="lineNum">     40 </span><span class="lineNoCov">    0 / 1     : 	kprobe_coverage_write_path = dir_concat(debugfs_path, &quot;kprobe-coverage/control&quot;); </span>
<span class="lineNum">     41 </span><span class="lineNoCov">    0 / 1     : 	kprobe_coverage_read_path = dir_concat(debugfs_path, &quot;kprobe-coverage/control&quot;); </span>
<span class="lineNum">     42 </span><span class="lineNoCov">    0 / 1     : 	panic_if (!file_exists(kprobe_coverage_write_path), </span>
<span class="lineNum">     43 </span>              : 			&quot;kprobe-coverage/control not found in debugfs\n&quot; </span>
<span class="lineNum">     44 </span>              : 			&quot;please load the kprobe_coverage module.\n&quot;); </span>
<span class="lineNum">     45 </span>              :  </span>
<span class="lineNum">     46 </span><span class="lineNoCov">    0 / 1     : 	fclose(fp); </span>
<span class="lineNum">     47 </span>              :  </span>
<span class="lineNum">     48 </span><span class="lineNoCov">    0 / 1     : 	return ret; </span>
<span class="lineNum">     49 </span><span class="lineNoCov">    0 / 1     : } </span>
<span class="lineNum">     50 </span>              :  </span>
<span class="lineNum">     51 </span>              : static int setup_breakpoints(struct kc *kc) </span>
<span class="lineNum">     52 </span><span class="lineNoCov">    0 / 1     : { </span>
<span class="lineNum">     53 </span>              : 	GHashTableIter iter; </span>
<span class="lineNum">     54 </span>              : 	unsigned long key; </span>
<span class="lineNum">     55 </span>              : 	struct kc_addr *val; </span>
<span class="lineNum">     56 </span><span class="lineNoCov">    0 / 1     : 	FILE *fp = fopen(kprobe_coverage_write_path, &quot;w&quot;); </span>
<span class="lineNum">     57 </span>              :  </span>
<span class="lineNum">     58 </span><span class="lineNoCov">    0 / 1     : 	panic_if(!fp, &quot;Can't open kprobe coverage file %s for writing\n&quot;, </span>
<span class="lineNum">     59 </span>              : 			kprobe_coverage_write_path); </span>
<span class="lineNum">     60 </span>              :  </span>
<span class="lineNum">     61 </span><span class="lineNoCov">    0 / 1     : 	g_hash_table_iter_init(&amp;iter, kc-&gt;addrs); </span>
<span class="lineNum">     62 </span><span class="lineNoCov">    0 / 2     : 	while (g_hash_table_iter_next(&amp;iter, (gpointer*)&amp;key, (gpointer*)&amp;val)) </span>
<span class="lineNum">     63 </span><span class="lineNoCov">    0 / 2     : 		fprintf(fp, &quot;%s%s0x%lx\n&quot;, </span>
<span class="lineNum">     64 </span><span class="lineNoCov">    0 / 1     : 				kc-&gt;module_name, strlen(kc-&gt;module_name) == 0 ? &quot;&quot; : &quot;:&quot;, </span>
<span class="lineNum">     65 </span><span class="lineNoCov">    0 / 1     : 				val-&gt;addr); </span>
<span class="lineNum">     66 </span>              :  </span>
<span class="lineNum">     67 </span><span class="lineNoCov">    0 / 1     : 	fclose(fp); </span>
<span class="lineNum">     68 </span>              :  </span>
<span class="lineNum">     69 </span><span class="lineNoCov">    0 / 1     : 	return 0; </span>
<span class="lineNum">     70 </span><span class="lineNoCov">    0 / 1     : } </span>
<span class="lineNum">     71 </span>              :  </span>
<span class="lineNum">     72 </span>              :  </span>
<span class="lineNum">     73 </span>              : void kprobe_coverage_run(struct kc *kc, const char *write_path, </span>
<span class="lineNum">     74 </span>              : 		const char *read_path) </span>
<span class="lineNum">     75 </span><span class="lineNoCov">    0 / 1     : { </span>
<span class="lineNum">     76 </span>              : 	FILE *fp; </span>
<span class="lineNum">     77 </span>              :  </span>
<span class="lineNum">     78 </span>              : 	/* First lookup the path */ </span>
<span class="lineNum">     79 </span><span class="lineNoCov">    0 / 2     : 	if (write_path &amp;&amp; read_path) { </span>
<span class="lineNum">     80 </span><span class="lineNoCov">    0 / 1     : 		kprobe_coverage_write_path = xstrdup(write_path); </span>
<span class="lineNum">     81 </span><span class="lineNoCov">    0 / 1     : 		kprobe_coverage_read_path = xstrdup(read_path); </span>
<span class="lineNum">     82 </span>              : 	} else </span>
<span class="lineNum">     83 </span><span class="lineNoCov">    0 / 1     : 		lookup_debugfs(); </span>
<span class="lineNum">     84 </span><span class="lineNoCov">    0 / 1     : 	setup_breakpoints(kc); </span>
<span class="lineNum">     85 </span>              :  </span>
<span class="lineNum">     86 </span><span class="lineNoCov">    0 / 1     : 	fp = fopen(kprobe_coverage_read_path, &quot;r&quot;); </span>
<span class="lineNum">     87 </span><span class="lineNoCov">    0 / 1     : 	panic_if (!fp, &quot;Can't open %s for reading\n&quot;, </span>
<span class="lineNum">     88 </span>              : 			kprobe_coverage_write_path); </span>
<span class="lineNum">     89 </span>              :  </span>
<span class="lineNum">     90 </span><span class="lineNoCov">    0 / 2     : 	while (!feof(fp)) { </span>
<span class="lineNum">     91 </span><span class="lineNoCov">    0 / 1     : 		char *line = NULL; </span>
<span class="lineNum">     92 </span>              : 		struct kc_addr *addr; </span>
<span class="lineNum">     93 </span>              : 		unsigned long l_addr; </span>
<span class="lineNum">     94 </span>              : 		char *endp; </span>
<span class="lineNum">     95 </span>              : 		char *p; </span>
<span class="lineNum">     96 </span><span class="lineNoCov">    0 / 1     : 		size_t sz = 0; </span>
<span class="lineNum">     97 </span>              :  </span>
<span class="lineNum">     98 </span><span class="lineNoCov">    0 / 1     : 		if (getline(&amp;line, &amp;sz, fp) &lt; 0) </span>
<span class="lineNum">     99 </span><span class="lineNoCov">    0 / 1     : 			break; </span>
<span class="lineNum">    100 </span><span class="lineNoCov">    0 / 1     : 		p = line; </span>
<span class="lineNum">    101 </span><span class="lineNoCov">    0 / 1     : 		if (strchr(p, ':')) </span>
<span class="lineNum">    102 </span><span class="lineNoCov">    0 / 1     : 			p = strchr(p, ':') + 1; </span>
<span class="lineNum">    103 </span><span class="lineNoCov">    0 / 1     : 		l_addr = strtoul(p, &amp;endp, 16); </span>
<span class="lineNum">    104 </span><span class="lineNoCov">    0 / 1     : 		free(line); </span>
<span class="lineNum">    105 </span>              :  </span>
<span class="lineNum">    106 </span><span class="lineNoCov">    0 / 1     : 		if (endp == p) </span>
<span class="lineNum">    107 </span><span class="lineNoCov">    0 / 1     : 			continue; </span>
<span class="lineNum">    108 </span><span class="lineNoCov">    0 / 1     : 		addr = kc_lookup_addr(kc, l_addr); </span>
<span class="lineNum">    109 </span><span class="lineNoCov">    0 / 1     : 		if (addr) </span>
<span class="lineNum">    110 </span><span class="lineNoCov">    0 / 1     : 			kc_addr_register_hit(addr); </span>
<span class="lineNum">    111 </span>              : 	} </span>
<span class="lineNum">    112 </span><span class="lineNoCov">    0 / 2     : } </span>
</pre>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr><td class="ruler"><img src="glass.png" width="3" height="3" alt=""/></td></tr>
  <tr><td class="versionInfo">Generated by: <a href="http://simonkagstrom.github.com/kcov/index.html">Kcov</a> (based on <a href="http://bcov.sourceforge.net">bcov</a>)</td></tr>
</table>
<br/>
</body>
</html>
