*** Settings ***
Library           OperatingSystem

*** Variables ***
${kcov}           %{WORKSPACE}/build/src/kcov
${out}            %{WORKSPACE}/kcov
${kcov_path}      %{WORKSPACE}
${xml_lookup}     ${kcov_path}/tests/tools/lookup-xml-node.py

*** Test Cases ***
too-few-arguments
    ${rc}=    Run and return RC    ${kcov} ${out}
    Should be equal as integers    ${rc}    1

wrong-arguments
    ${rc}=    Run and return RC    ${kcov} --abcd=efg ${out} tests-stripped
    Should be equal as integers    ${rc}    1

fork-no-wait
    ${no_kcov_rc}=    Run and return RC    ./fork_no_wait
    ${rc}=    Run and return RC    ${kcov} ${out} ./fork_no_wait
    Should be equal as integers    ${rc}    ${no_kcov_rc}
    ${output}=    Run    ${xml_lookup} ${out}/fork_no_wait/cobertura.xml fork_no_wait_c 20
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/fork_no_wait/cobertura.xml fork_no_wait_c 22
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/fork_no_wait/cobertura.xml fork_no_wait_c 24
    Should Contain    ${output}    1

fork
    ${no_kcov_rc}=    Run and return RC    ./fork
    ${rc}=    Run and return RC    ${kcov} ${out} ./fork
    Should be equal as integers    ${rc}    ${no_kcov_rc}
    ${output}=    Run    ${xml_lookup} ${out}/fork/cobertura.xml fork_c 21
    Should Contain    ${output}    0
    ${output}=    Run    ${xml_lookup} ${out}/fork/cobertura.xml fork_c 26
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/fork/cobertura.xml fork_c 34
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/fork/cobertura.xml fork_c 37
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/fork/cobertura.xml fork_c 46
    Should Contain    ${output}    1

shared-library
    ${no_kcov_rc}=    Run and return RC    ./shared_library_test
    ${rc}=    Run and return RC    ${kcov} ${out} ./shared_library_test
    Should be equal as integers    ${rc}    ${no_kcov_rc}
    ${output}=    Run    ${xml_lookup} ${out}/shared_library_test/cobertura.xml main_c 9
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/shared_library_test/cobertura.xml solib_c 5
    Should Contain    ${output}    1

shared-library-filter-out
    ${no_kcov_rc}=    Run and return RC    ./shared_library_test
    ${rc}=    Run and return RC    ${kcov} --exclude-pattern=solib ${out} ./shared_library_test
    Should be equal as integers    ${rc}    ${no_kcov_rc}
    ${output}=    Run    ${xml_lookup} ${out}/shared_library_test/cobertura.xml main_c 9
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/shared_library_test/cobertura.xml solib_c 5
    Should Contain    ${output}    nocode

main-test
    ${no_kcov_rc}=    Run and return RC    ./main-tests
    ${rc}=    Run and return RC    ${kcov} ${out} ./main-tests
    Should be equal as integers    ${rc}    ${no_kcov_rc}
    ${output}=    Run    ${xml_lookup} ${out}/main-tests/cobertura.xml main_cc 9
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/main-tests/cobertura.xml main_cc 14
    Should Contain    ${output}    nocode
    ${output}=    Run    ${xml_lookup} ${out}/main-tests/cobertura.xml main_cc 18
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/main-tests/cobertura.xml main_cc 25
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/main-tests/cobertura.xml file_c 6
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/main-tests/cobertura.xml file_c 7
    Should Contain    ${output}    0

accumulate-data
    Run                            rm -rf ${out}/argv_dependent/
    ${rc}=    Run and return RC    ${kcov} ${out} ./argv_dependent
    Should be equal as integers    ${rc}    0
    ${output}=    Run    ${xml_lookup} ${out}/argv_dependent/cobertura.xml argv_dependent_c 5
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/argv_dependent/cobertura.xml argv_dependent_c 11
    Should Contain    ${output}    0
    ${rc}=    Run and return RC    ${kcov} ${out} ./argv_dependent a
    Should be equal as integers    ${rc}    0
    ${output}=    Run    ${xml_lookup} ${out}/argv_dependent/cobertura.xml argv_dependent_c 11
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/argv_dependent/cobertura.xml argv_dependent_c 5
    Should Contain    ${output}    1

popen-test
    ${no_kcov_rc}=    Run and return RC    ./test_popen
    ${rc}=    Run and return RC    ${kcov} ${out} ./test_popen
    Should be equal as integers    ${rc}    ${no_kcov_rc}
    ${output}=    Run    ${kcov} ${out} ./test_popen
    Should Contain    ${output}    popen OK

global-constructors-test
    ${no_kcov_rc}=    Run and return RC    ./global-constructors
    ${rc}=    Run and return RC    ${kcov} ${out} ./global-constructors
    Should be equal as integers    ${rc}    ${no_kcov_rc}
    ${output}=    Run    ${xml_lookup} ${out}/global-constructors/cobertura.xml test_global_ctors_cc 4
    Should Contain    ${output}    1

daemon-wait-for-last-child-test
	Run                            rm -rf ${out}/test_daemon
    ${no_kcov_rc}=    Run and return RC    ./test_daemon
    Should be equal as integers    ${no_kcov_rc}    2
    ${rc}=    Run and return RC    ${kcov} ${out} ./test_daemon
    Should be equal as integers    ${rc}    4
    ${output}=    Run    ${xml_lookup} ${out}/test_daemon/cobertura.xml test_daemon_cc 31
    Should Contain    ${output}    1
    
daemon-no-wait-for-last-child-test
	Run                            rm -rf ${out}/test_daemon/cobertura.xml
    ${no_kcov_rc}=    Run and return RC    ./test_daemon
    ${rc}=    Run and return RC    ${kcov} --exit-first-process ${out} ./test_daemon
    Should be equal as integers    ${no_kcov_rc}    ${rc}
    ${output}=    Run    ${xml_lookup} ${out}/test_daemon/cobertura.xml test_daemon_cc 31
    Should Contain    ${output}    0
    Run                            sleep 5
    ${output}=    Run    ${xml_lookup} ${out}/test_daemon/cobertura.xml test_daemon_cc 31
    Should Contain    ${output}    1
    
signals
	Run                            rm -rf ${out}/signals/cobertura.xml
    ${no_kcov_rc}=    Run and return RC    ./signals hup
    ${rc}=    Run and return RC    ${kcov} ${out} ./signals hup
    Should be equal as integers    ${no_kcov_rc}    ${rc}
    ${output}=    Run    ${xml_lookup} ${out}/signals/cobertura.xml test_signals_c 14
    ${no_kcov_rc}=    Run and return RC    ./signals int
    ${rc}=    Run and return RC    ${kcov} ${out} ./signals int
    Should be equal as integers    ${no_kcov_rc}    ${rc}
    ${output}=    Run    ${xml_lookup} ${out}/signals/cobertura.xml test_signals_c 19
    ${no_kcov_rc}=    Run and return RC    ./signals quit
    ${rc}=    Run and return RC    ${kcov} ${out} ./signals quit
    Should be equal as integers    ${no_kcov_rc}    ${rc}
    ${output}=    Run    ${xml_lookup} ${out}/signals/cobertura.xml test_signals_c 24
    ${no_kcov_rc}=    Run and return RC    ./signals abrt
    ${rc}=    Run and return RC    ${kcov} ${out} ./signals abrt
    Should be equal as integers    ${no_kcov_rc}    ${rc}
    ${output}=    Run    ${xml_lookup} ${out}/signals/cobertura.xml test_signals_c 39
    ${no_kcov_rc}=    Run and return RC    ./signals segv
    ${rc}=    Run and return RC    ${kcov} ${out} ./signals segv
    Should be equal as integers    ${no_kcov_rc}    ${rc}
    ${output}=    Run    ${xml_lookup} ${out}/signals/cobertura.xml test_signals_c 69
    ${no_kcov_rc}=    Run and return RC    ./signals term
    ${rc}=    Run and return RC    ${kcov} ${out} ./signals term
    Should be equal as integers    ${no_kcov_rc}    ${rc}
    ${output}=    Run    ${xml_lookup} ${out}/signals/cobertura.xml test_signals_c 89

signals-self
	Run								rm -rf ${out}/signals/cobertura.xml
    ${output}=   Run				${kcov} ${out} ./signals segv self
	Should Contain					${output}	kcov: Process exited with signal 11
    ${output}=   Run				${kcov} ${out} ./signals abrt self
	Should Contain					${output}	kcov: Process exited with signal 6

collect-only-and-report-only
	Run								rm -rf ${out}/main-tests/
    ${no_kcov_rc}=    Run and return RC    ./main-tests
    ${rc}=    Run and return RC    ${kcov} --collect-only ${out} ./main-tests
    Should be equal as integers    ${rc}    ${no_kcov_rc}
    ${rc}=    Run and return RC    test -e ${out}/main-tests/cobertura.xml
    Should be equal as integers    ${rc}    1
    ${rc}=    Run and return RC    ${kcov} --collect-only ${out} ./main-tests
    Should be equal as integers    ${rc}    0
    ${output}=    Run    ${xml_lookup} ${out}/main-tests/cobertura.xml main_cc 9
    Should Contain    ${output}    1

python-exit-status
	Run								rm -rf ${out}/main
    ${no_kcov_rc}=    Run and return RC    python ${kcov_path}/tests/python/main 5
    ${rc}=    Run and return RC    ${kcov} ${out} ${kcov_path}/tests/python/main 5
    Should be equal as integers    ${rc}    ${no_kcov_rc}

python-coverage
	Run								rm -rf ${out}/main
    ${rc}=    Run and return RC    ${kcov} ${out} ${kcov_path}/tests/python/main 5
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml main 10
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml main 17
    Should Contain    ${output}    0
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml main 22
    Should Contain    ${output}    nocode
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml second_py 2
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml second_py 4
    Should Contain    ${output}    nocode
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml second_py 11
    Should Contain    ${output}    nocode
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml second_py 30
    Should Contain    ${output}    0

python-accumulate-data
	Run								rm -rf ${out}/main
    ${rc}=    Run and return RC    ${kcov} ${out} ${kcov_path}/tests/python/main 5
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml main 16
    Should Contain    ${output}    0
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml main 19
    Should Contain    ${output}    1
    ${rc}=    Run and return RC    ${kcov} ${out} ${kcov_path}/tests/python/main
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml main 16
    Should Contain    ${output}    1
    ${output}=    Run    ${xml_lookup} ${out}/main/cobertura.xml main 19
    Should Contain    ${output}    1
